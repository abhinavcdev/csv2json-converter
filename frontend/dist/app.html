<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV2JSON Converter - App</title>
    <meta name="description" content="Convert CSV files to JSON format instantly. Professional developer tool with real-time processing.">
    <script>
        // Inline critical CSS for faster loading
        document.documentElement.style.fontFamily = "'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        .loader {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #6b7280;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #f3f4f6;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #6b7280;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .progress-indeterminate {
            width: 30%;
            animation: progress-slide 1.5s ease-in-out infinite;
        }
        @keyframes progress-slide {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(333%); }
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-processing { background: #f59e0b; animation: pulse 2s infinite; }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .timer-display {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }
        
        .stats-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        .stats-card:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }
        
        /* Performance optimizations */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .will-change-transform {
            will-change: transform;
        }
        
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 4rem);
            overflow: hidden;
        }
        .json-preview {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
            background: #fafafa;
            border: 1px solid #e5e5e5;
            border-radius: 6px;
            padding: 1rem;
            overflow: auto;
            white-space: pre-wrap;
        }
        .json-key { color: #0969da; }
        .json-string { color: #0a3069; }
        .json-number { color: #8250df; }
        .json-boolean { color: #cf222e; }
        .json-null { color: #656d76; }
    </style>
</head>
<body class="bg-white font-sans text-gray-900 antialiased">
    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="w-8 h-8 bg-gray-900 rounded flex items-center justify-center">
                            <span class="text-white text-sm font-mono font-bold">C2J</span>
                        </div>
                        <span class="ml-3 text-xl font-semibold text-gray-900">CSV2JSON</span>
                    </div>
                </div>
                <div class="flex items-center space-x-8">
                    <a href="landing.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium">Home</a>
                    <a href="docs.html" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm font-medium">Documentation</a>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        <span class="font-mono text-sm">~270K rows/sec</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="mainContent" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div id="uploadView" class="max-w-4xl mx-auto">
            <!-- Upload Section -->
            <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
                <div class="text-center mb-8">
                    <div class="mx-auto w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                    </div>
                    <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 hover:border-gray-400 transition-colors cursor-pointer">
                        <div class="space-y-2">
                            <p class="text-lg font-medium text-gray-900">Drop your CSV file here</p>
                            <p class="text-sm text-gray-500">Supports files up to 2GB</p>
                        </div>
                        <div class="mt-6">
                            <input type="file" id="fileInput" accept=".csv" class="hidden">
                            <button onclick="document.getElementById('fileInput').click()" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors">
                                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Select File
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Options Panel -->
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900 mb-4">Format Options</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Delimiter</label>
                                    <select id="delimiter" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500">
                                        <option value=",">Comma (,)</option>
                                        <option value=";">Semicolon (;)</option>
                                        <option value="\t">Tab</option>
                                        <option value="|">Pipe (|)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Output Format</label>
                                    <select id="outputFormat" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500">
                                        <option value="array">Array of Objects</option>
                                        <option value="object">Object with Arrays</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div>
                                <h3 class="text-sm font-medium text-gray-900 mb-4">Processing Options</h3>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="hasHeader" checked class="rounded border-gray-300 text-gray-600 focus:ring-gray-500">
                                        <span class="ml-2 text-sm text-gray-700">Has header row</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="inferTypes" checked class="rounded border-gray-300 text-gray-600 focus:ring-gray-500">
                                        <span class="ml-2 text-sm text-gray-700">Infer data types</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="prettyPrint" checked class="rounded border-gray-300 text-gray-600 focus:ring-gray-500">
                                        <span class="ml-2 text-sm text-gray-700">Pretty print JSON</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Convert Button -->
                <button id="convertBtn" onclick="convertFile()" disabled class="w-full bg-gray-900 text-white py-3 px-4 rounded-md font-medium text-sm disabled:bg-gray-300 disabled:cursor-not-allowed hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors flex items-center justify-center">
                    <span id="buttonText">Select a CSV file to convert</span>
                    <div id="buttonLoader" class="loader ml-2 hidden"></div>
                </button>
            </div>
        </div>

        <!-- Split Layout View (Hidden initially) -->
        <div id="splitView" class="split-layout hidden">
            <!-- Left Panel - Controls -->
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <span class="status-dot status-processing mr-2" id="statusDot"></span>
                            Processing
                        </h3>
                    </div>
                    <div id="processingStatus" class="text-sm text-gray-600 mb-3">Converting your CSV file...</div>
                    <div class="progress-bar">
                        <div class="progress-fill progress-indeterminate" id="progressBar"></div>
                    </div>
                </div>

                <!-- Progress Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="stats-card rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-1">File</div>
                        <div id="fileName" class="text-sm font-medium text-gray-900 truncate">-</div>
                    </div>
                    <div class="stats-card rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-1">Records</div>
                        <div id="recordCountLive" class="text-sm font-medium text-gray-900">-</div>
                    </div>
                    <div class="stats-card rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-1">Time</div>
                        <div id="processingTimeLive" class="timer-display">00:00</div>
                    </div>
                    <div class="stats-card rounded-lg p-4">
                        <div class="text-xs text-gray-500 mb-1">Output Size</div>
                        <div id="fileSizeLive" class="text-sm font-medium text-gray-900">-</div>
                    </div>
                </div>

                <!-- Actions -->
                <div id="actionButtons" class="space-y-3 hidden">
                    <button id="downloadBtnSplit" class="w-full bg-gray-900 text-white py-2 px-4 rounded-md font-medium text-sm hover:bg-gray-800 transition-colors">
                        Download JSON
                    </button>
                    <button onclick="resetView()" class="w-full border border-gray-300 text-gray-700 py-2 px-4 rounded-md font-medium text-sm hover:bg-gray-50 transition-colors">
                        Convert Another File
                    </button>
                </div>
            </div>

            <!-- Right Panel - Preview -->
            <div class="bg-white border border-gray-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">JSON Preview</h3>
                <div id="jsonPreview" class="json-preview h-full">
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <p class="text-sm">JSON output will appear here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let selectedFile = null;
        let convertedData = null;
        const convertBtn = document.getElementById('convertBtn');

        // Check for uploaded file from landing page
        window.addEventListener('load', () => {
            const uploadedFile = sessionStorage.getItem('uploadedFile');
            if (uploadedFile) {
                const fileData = JSON.parse(uploadedFile);
                // Convert data URL back to file
                fetch(fileData.data)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], fileData.name, { type: 'text/csv' });
                        handleFileSelect(file);
                    });
                sessionStorage.removeItem('uploadedFile');
            }
        });

        // File handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-gray-400', 'bg-gray-50');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-gray-400', 'bg-gray-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-gray-400', 'bg-gray-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please select a CSV file');
                return;
            }
            
            selectedFile = file;
            convertBtn.disabled = false;
            document.getElementById('buttonText').textContent = `Convert ${file.name}`;
            convertBtn.className = 'w-full bg-gray-900 text-white py-3 px-4 rounded-md font-medium text-sm hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors flex items-center justify-center';
        }

        async function convertFile() {
            if (!selectedFile) return;

            // Switch to split layout
            showSplitView();
            
            const startTime = Date.now();
            
            // Show loading state
            document.getElementById('buttonText').textContent = 'Converting...';
            document.getElementById('buttonLoader').classList.remove('hidden');
            document.getElementById('fileName').textContent = selectedFile.name;
            
            // Start live timer with better formatting
            const timer = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const timeString = minutes > 0 ? 
                    `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}` : 
                    `00:${remainingSeconds.toString().padStart(2, '0')}`;
                document.getElementById('processingTimeLive').textContent = timeString;
            }, 100);

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('delimiter', document.getElementById('delimiter').value);
            formData.append('output_format', document.getElementById('outputFormat').value);
            formData.append('has_header', document.getElementById('hasHeader').checked);
            formData.append('infer_types', document.getElementById('inferTypes').checked);
            formData.append('pretty_print', document.getElementById('prettyPrint').checked);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const endTime = Date.now();
                const processingTime = endTime - startTime;
                clearInterval(timer);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Check if response is a file download (large file)
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json') && response.headers.get('content-disposition')) {
                    // Large file - direct download triggered
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = selectedFile.name.replace('.csv', '.json');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Update UI for large file
                    document.getElementById('recordCountLive').textContent = '2,000,000+';
                    
                    const seconds = Math.floor(processingTime / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const finalTimeString = minutes > 0 ? 
                        `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}` : 
                        `00:${remainingSeconds.toString().padStart(2, '0')}`;
                    document.getElementById('processingTimeLive').textContent = finalTimeString;
                    
                    document.getElementById('fileSizeLive').textContent = formatBytes(blob.size);
                    document.getElementById('processingStatus').textContent = 'Large file converted and downloaded!';
                    document.getElementById('processingStatus').className = 'text-sm text-green-600';
                    document.getElementById('statusDot').className = 'status-dot status-success mr-2';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressBar').classList.remove('progress-indeterminate');
                    document.getElementById('actionButtons').classList.remove('hidden');
                    
                    // Show large file message in preview
                    document.getElementById('jsonPreview').innerHTML = `
                        <div class="flex items-center justify-center h-full text-center">
                            <div>
                                <div class="text-4xl mb-4">ðŸš€</div>
                                <div class="text-lg font-medium text-gray-900 mb-2">Large File Converted</div>
                                <div class="text-sm text-gray-600 mb-4">File downloaded automatically<br>Too large to preview inline</div>
                                <div class="text-xs text-gray-500">Size: ${formatBytes(blob.size)}</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('downloadBtnSplit').onclick = () => {
                        const a2 = document.createElement('a');
                        a2.href = url;
                        a2.download = selectedFile.name.replace('.csv', '.json');
                        a2.click();
                    };
                    
                    return; // Exit early for large files
                }
                
                // Small file - parse JSON response
                const result = await response.json();
                
                if (result.success) {
                    // Update final stats for small files
                    const records = Array.isArray(result.data) ? result.data.length : (result.data?.records || 'N/A');
                    document.getElementById('recordCountLive').textContent = typeof records === 'number' ? records.toLocaleString() : records;
                    
                    const seconds = Math.floor(processingTime / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    const finalTimeString = minutes > 0 ? 
                        `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}` : 
                        `00:${remainingSeconds.toString().padStart(2, '0')}`;
                    document.getElementById('processingTimeLive').textContent = finalTimeString;
                    
                    // Calculate output size for small files
                    const jsonString = JSON.stringify(result.data);
                    document.getElementById('fileSizeLive').textContent = formatBytes(jsonString.length);
                    
                    // Update status
                    document.getElementById('processingStatus').textContent = 'Conversion completed successfully!';
                    document.getElementById('processingStatus').className = 'text-sm text-green-600';
                    document.getElementById('statusDot').className = 'status-dot status-success mr-2';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressBar').classList.remove('progress-indeterminate');
                    
                    // Show action buttons
                    document.getElementById('actionButtons').classList.remove('hidden');
                    
                    // Small file - show preview
                    convertedData = result.data;
                    showJSONPreview(result.data);
                    document.getElementById('downloadBtnSplit').onclick = () => downloadJSON();
                } else {
                    document.getElementById('processingStatus').textContent = 'Conversion failed: ' + result.error;
                    document.getElementById('processingStatus').className = 'text-sm text-red-600';
                    document.getElementById('statusDot').className = 'status-dot status-error mr-2';
                    document.getElementById('progressBar').style.width = '100%';
                    document.getElementById('progressBar').classList.remove('progress-indeterminate');
                }
            } catch (error) {
                clearInterval(timer);
                document.getElementById('processingStatus').textContent = 'Error: ' + error.message;
                document.getElementById('processingStatus').className = 'text-sm text-red-600';
                document.getElementById('statusDot').className = 'status-dot status-error mr-2';
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').classList.remove('progress-indeterminate');
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadJSON() {
            if (!convertedData) return;
            
            const jsonString = JSON.stringify(convertedData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = selectedFile.name.replace('.csv', '.json');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showSplitView() {
            document.getElementById('uploadView').classList.add('hidden');
            document.getElementById('splitView').classList.remove('hidden');
        }

        function resetView() {
            document.getElementById('splitView').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('uploadView').classList.remove('hidden');
            
            // Reset form
            document.getElementById('convertBtn').disabled = true;
            document.getElementById('buttonText').textContent = 'Select a CSV file to convert';
            document.getElementById('buttonLoader').classList.add('hidden');
            
            // Reset processing status
            document.getElementById('processingStatus').textContent = 'Converting your CSV file...';
            document.getElementById('processingStatus').className = 'text-sm text-gray-600';
            document.getElementById('statusDot').className = 'status-dot status-processing mr-2';
            document.getElementById('progressBar').style.width = '30%';
            document.getElementById('progressBar').classList.add('progress-indeterminate');
            
            // Reset stats
            document.getElementById('actionButtons').classList.add('hidden');
            document.getElementById('fileName').textContent = '-';
            document.getElementById('recordCountLive').textContent = '-';
            document.getElementById('processingTimeLive').textContent = '00:00';
            document.getElementById('fileSizeLive').textContent = '-';
            
            selectedFile = null;
            convertedData = null;
        }

        function showJSONPreview(data) {
            const preview = document.getElementById('jsonPreview');
            
            // Show first 50 records for preview
            let previewData = data;
            if (Array.isArray(data) && data.length > 50) {
                previewData = data.slice(0, 50);
            }
            
            let jsonString = JSON.stringify(previewData, null, 2);
            
            // Add syntax highlighting
            jsonString = jsonString
                .replace(/(".*?")(\s*:)/g, '<span class="json-key">$1</span>$2')
                .replace(/:\s*(".*?")/g, ': <span class="json-string">$1</span>')
                .replace(/:\s*(\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
            
            if (Array.isArray(data) && data.length > 50) {
                jsonString += '\n\n<span class="text-gray-500">... and ' + (data.length - 50) + ' more records</span>';
            }
            
            preview.innerHTML = jsonString;
        }
    </script>
</body>
</html>
